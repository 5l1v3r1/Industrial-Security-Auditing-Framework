import subprocess
from Base import Validators
from Base.Exploits import Exploit, Option
from Utils import print_error, print_success


class Exploit(Exploit):
    __info__ = {
        'name': 'exploits/modbus/read',
        'display_name': 'Modbus Read',
        'authors': [
            'D0ubl3G <d0ubl3g[at]protonmail.com>',
        ],
        'description': 'Modbus register read using modbus-cli.',
        'references': [
            'https://github.com/tallakt/modbus-cli',
        ],
        'devices': [
            'Schneider',
            'Modicon',
        ],
    }

    target = Option('192.168.1.1', 'Target address.', validators=Validators.ipv4)
    port = Option(502, 'Target Port')
    address = Option('%MW100', 'Target Register Address (Schneider-like and Modicon-like addresses)')
    limit = Option('100', 'Register Limit')

    def run(self):
        try:
            output = subprocess.check_output(['modbus', 'read', self.target, self.address, self.limit],
                                             stderr=subprocess.STDOUT)
            print_success(output)
        except:
            print_error("Connection Error. Aborting.")
